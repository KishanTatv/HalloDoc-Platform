@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@


@{
    ViewData["Title"] = "Provider Location";
    Layout = "~/Views/Shared/_LayoutDashbord.cshtml";
}


<link rel="stylesheet" href="~/css/Shift.css" asp-append-version="true" />
@*<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>*@
<script src='https://cdn.jsdelivr.net/npm/fullcalendar-scheduler@6.1.11/index.global.min.js'></script>


<div class="MainContent pt-0 min-vh-100">
    <partial name="partial/AdminNavTab" />

    <div class="HContainer m-auto">
        <div class="d-flex justify-content-between mt-4">
            <h4>Schedulig</h4>
            <a class="btn w-5 btn-info rounded bg-transparent m-2 text-info" asp-controller="AdminDash" asp-action="Dashbord">
                <strong class="pe-2">&lt Back</strong>
            </a>
        </div>
        <div class="d-flex justify-content-between mt-2">
            <div class="w-25">
                <select class="form-select" aria-label="Floating label select example">
                    <option selected>All Region</option>
                    <option value="1">Surat</option>
                </select>
            </div>
            <div>
                <button type="button" class="btn btn-info text-light me-2">Providers On Call</button>
                <button type="button" class="btn btn-info text-light me-2">Shift For Review</button>
                <button type="button" class="btn btn-info text-light AddNewShift">Add New Shift</button>
            </div>
        </div>
        <div>
            <div id="dateDisplay" class="h5 mt-3 mb-0"></div>
        </div>
        <div class="d-flex justify-content-end mb-4">
            <span><button class="btn penShift h-100 me-2"></button></span><span class="me-3">Pending Shift</span>
            <span><button class="btn apprvShift h-100 me-2"></button></span><span>Approved Shift</span>
        </div>
        <div class="d-flex justify-content-between">
            <div>
                <button id="cal-prev" class="btn btn-info rounded-circle"><i class="bi bi-chevron-compact-left"></i></button>
                <span id="cal-today" class="ms-2 me-2"><i class="bi bi-calendar-check-fill"></i></span>
                <button id="cal-next" class="btn btn-info rounded-circle"><i class="bi bi-chevron-compact-right"></i></button>
            </div>
            <div>
                <button id="DaySchedule" class="btn btn-outline-info text-black me-2">Day</</button>
                <button id="WeekSchedule" class="btn btn-outline-info text-black me-2">Week</</button>
                <button id="MonthSchedule" class="btn btn-outline-info text-black">Month</</button>
            </div>
        </div>

        <div id='calendar' class="mt-4"></div>
        <div id="PartialPopup"></div>
    </div>
</div>

<script asp-append-version="true">

    function updateDateDisplay(date) {
        var formattedDate;
        if (calendar.view.type === 'dayGridMonth') {
            formattedDate = date.toLocaleString('default', { month: 'short', year: 'numeric' });
        } else if (calendar.view.type === 'dayGridWeek') {
            var startOfWeek = new Date(date);
            startOfWeek.setDate(date.getDate() - date.getDay() + (date.getDay() === 0 ? -6 : 1)); // Get the first day of the week
            var endOfWeek = new Date(date);
            endOfWeek.setDate(startOfWeek.getDate() + 6); // Get the last day of the week
            formattedDate = startOfWeek.toLocaleString('default', { month: 'short', day: '2-digit' }) + ' - ' +
                endOfWeek.toLocaleString('default', { month: 'short', day: '2-digit', year: 'numeric' });
        } else if (calendar.view.type === 'resourceTimelineDay') {
            formattedDate = date.toLocaleString('default', { weekday: 'long', month: 'short', day: '2-digit', year: 'numeric' });
        }
        document.getElementById("dateDisplay").innerHTML = formattedDate;
    }

    var calendarEl = document.getElementById('calendar');
    var calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        selectable: true,
    });

    function scheduleRecord(){
        $.ajax({
            url: '/AdminTab/getScheduleData',
            success: function (response) {
                const shiftData = response.shiftdetail;
                console.log(shiftData);

                const events = shiftData.map((shift) => ({
                    id: shift.shiftdetailid,
                    title: `${shift.endtime} ${shift.shiftdetailid}`,
                    start: `${shift.shiftdate}T${shift.starttime}`,
                    end: `${shift.shiftdate}T${shift.endtime}`,
                }));


                calendar.setOption('events', events);
            },
            error: function (xhr, status, error) {
                console.error(xhr.responseText);
            }
        });
    }


    updateDateDisplay(calendar.getDate());
    scheduleRecord();
    calendar.render();

    $('#WeekSchedule').click(function () {
        calendar.changeView('dayGridWeek');
        scheduleRecord();
        updateDateDisplay(calendar.getDate());
    });

    $('#MonthSchedule').click(function () {
        calendar.changeView('dayGridMonth');
        updateDateDisplay(calendar.getDate());
    });

    $('#DaySchedule').click(function () {
        scheduleRecord();
        calendar.changeView('resourceTimelineDay');
        calendar.setOption('aspectRatio', 1.5);
        calendar.setOption('resourceAreaColumns', [
            {
                field: 'title',
                headerContent: 'Staff'
            }
        ]);

        $.ajax({
            url: '/AdminTab/getPhysicianRecord',
            success: function (response) {
                console.log(response.phyCustomNameViewModel);
                const resources = response.phyCustomNameViewModel.map((physician) => ({
                    id: physician.physicianid,
                    title: `${physician.firstname} ${physician.lastname}`,
                }));
                calendar.setOption('resources', resources);
            },
            error: function (xhr, status, error) {
                console.error(xhr.responseText);
            }
        });
        
        updateDateDisplay(calendar.getDate());
    });


    $('#cal-prev').click(function () {
        calendar.prev();
        var currentDate = calendar.getDate();
        updateDateDisplay(currentDate);
    });
    $('#cal-next').click(function () {
        calendar.next();
        var currentDate = calendar.getDate();
        updateDateDisplay(currentDate);
    });
    $('#cal-today').click(function () {
        calendar.today();
        var currentDate = calendar.getDate();
        updateDateDisplay(currentDate);
    });

    $('.AddNewShift').click(function () {
        $.ajax({
            url: '/AdminTab/NewShiftPopUp',
            success: function (response) {
                $("#PartialPopup").html(response);
                var my = new bootstrap.Modal(document.getElementById('NewShift'));
                my.show();
            },
            error: function (xhr, status, error) {
                console.error(xhr.responseText);
            }
        });
    });
</script>